generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                    @id @default(cuid())
  name                     String?
  email                    String                    @unique
  emailVerified            DateTime?
  image                    String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  role                     String                    @default("user")
  isPremium                Boolean                   @default(false)
  accounts                 Account[]
  brandProfile             BrandProfile?
  reviewRequestCampaigns   ReviewRequestCampaign[]
  reviewRequestCustomers   ReviewRequestCustomer[]
  reviewRequestDatasets    ReviewRequestDataset[]
  reviewRequestQueueItems  ReviewRequestQueueItem[]
  sessions                 Session[]
  socialAutoposterSettings SocialAutoposterSettings?
  socialDeliveryAttempts   SocialDeliveryAttempt[]
  socialQueueItems         SocialQueueItem[]
  usageCounters            UsageCounter[]
  socialAccountConnections SocialAccountConnection[]
  socialPostingDestinations SocialPostingDestination[]
  socialPublishAttempts    SocialPublishAttempt[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProReport {
  id           String    @id @default(cuid())
  shareId      String    @unique
  html         String
  pdfBase64    String?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  businessName String
  city         String
  state        String
  score        Int
  accessToken  String?

  @@index([shareId])
  @@index([businessName, city, state])
  @@index([expiresAt])
}

model UsageCounter {
  id            String   @id @default(cuid())
  userId        String
  appId         String
  dayKey        String
  conceptsCount Int      @default(0)
  imagesCount   Int      @default(0)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appId, dayKey])
  @@index([userId, appId, dayKey])
  @@index([dayKey])
}

model BrandProfile {
  id                         String   @id @default(cuid())
  userId                     String   @unique
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  businessName               String?
  businessType               String?
  city                       String?
  state                      String?
  brandPersonality           String?
  targetAudience             String?
  differentiators            String?
  inspirationBrands          String?
  avoidStyles                String?
  brandVoice                 String?
  toneNotes                  String?
  language                   String?
  industryKeywords           String?
  vibeKeywords               String?
  variationMode              String?
  includeHashtags            Boolean  @default(false)
  hashtagStyle               String?
  includeSocialPostTemplates Boolean  @default(false)
  includeFAQStarter          Boolean  @default(false)
  includeGBPDescription      Boolean  @default(false)
  includeMetaDescription     Boolean  @default(false)
  colorsJson                 Json?
  typographyJson             Json?
  messagingJson              Json?
  kitJson                    Json?
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ReviewRequestCampaign {
  id                String                   @id @default(cuid())
  userId            String
  businessName      String
  businessType      String?
  campaignName      String?
  platform          String
  reviewLinkUrl     String
  languageMode      String
  toneStyle         String
  brandVoice        String?
  channelMode       String
  triggerType       String
  sendDelayHours    Int                      @default(24)
  followUpEnabled   Boolean                  @default(false)
  followUpDelayDays Int?
  frequencyCapDays  Int                      @default(30)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  user              User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customers         ReviewRequestCustomer[]
  datasets          ReviewRequestDataset[]
  queueItems        ReviewRequestQueueItem[]

  @@index([userId])
  @@index([userId, createdAt])
}

model ReviewRequestCustomer {
  id            String                   @id @default(cuid())
  userId        String
  campaignId    String
  name          String
  email         String?
  phone         String?
  tags          String[]                 @default([])
  lastVisitDate DateTime?
  serviceType   String?
  jobId         String?
  optedOut      Boolean                  @default(false)
  createdAt     DateTime                 @default(now())
  campaign      ReviewRequestCampaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user          User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  queueItems    ReviewRequestQueueItem[]

  @@index([userId])
  @@index([campaignId])
  @@index([userId, createdAt])
}

model ReviewRequestQueueItem {
  id            String                @id @default(cuid())
  userId        String
  campaignId    String
  customerId    String
  scheduledAt   DateTime
  channel       ReviewRequestChannel
  variant       ReviewRequestVariant
  status        ReviewRequestStatus   @default(PENDING)
  skippedReason String?
  sentAt        DateTime?
  clickedAt     DateTime?
  reviewedAt    DateTime?
  optedOutAt    DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  campaign      ReviewRequestCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  customer      ReviewRequestCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([campaignId])
  @@index([customerId])
  @@index([userId, createdAt])
  @@index([status])
}

model ReviewRequestDataset {
  id           String                @id @default(cuid())
  userId       String
  campaignId   String
  snapshotId   String
  computedAt   DateTime              @default(now())
  totalsJson   Json
  warningsJson Json?
  createdAt    DateTime              @default(now())
  campaign     ReviewRequestCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([campaignId])
  @@index([userId, computedAt])
  @@index([snapshotId])
}

model SocialAutoposterSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  brandVoice            String?
  postingMode           String   @default("review")
  frequency             String?
  allowedDays           String[] @default([])
  timeWindowStart       String?
  timeWindowEnd         String?
  timezone              String?  @default("America/New_York")
  enabledPlatforms      String[] @default([])
  platformsEnabled      Json?
  platformOverrides     Json?
  contentPillarSettings Json?
  hashtagBankSettings   Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  imageSettings         Json?
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SocialQueueItem {
  id                  String                  @id @default(cuid())
  userId              String
  platform            SocialPlatform
  content             String
  status              QueueStatus             @default(draft)
  scheduledAt         DateTime?
  postedAt            DateTime?
  errorMessage        String?
  attemptCount        Int                     @default(0)
  nextAttemptAt       DateTime?
  lastErrorCode       String?
  metadata            Json?
  contentTheme        String?
  contentHash         String?
  contentFingerprint  String?
  reason              String?
  isSimilar           Boolean                 @default(false)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  imageStatus         String?
  imageUrl            String?
  imageAltText        String?
  imageProvider       String?
  imageAspect         String?
  imageCategory       String?
  imageErrorCode      String?
  imageFallbackReason String?
  imageRequestId      String?
  imageRequest        ImageRequest?           @relation(fields: [imageRequestId], references: [requestId])
  deliveryAttempts    SocialDeliveryAttempt[]
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([scheduledAt])
  @@index([userId, scheduledAt])
  @@index([nextAttemptAt])
  @@index([userId, nextAttemptAt])
  @@index([userId, platform, contentHash])
  @@index([contentHash])
}

model SocialDeliveryAttempt {
  id           String          @id @default(cuid())
  userId       String
  queueItemId  String
  platform     SocialPlatform
  success      Boolean
  errorMessage String?
  responseData Json?
  attemptedAt  DateTime        @default(now())
  queueItem    SocialQueueItem @relation(fields: [queueItemId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([queueItemId])
  @@index([userId, attemptedAt])
  @@index([success])
}

enum ReviewRequestChannel {
  EMAIL
  SMS
}

enum ReviewRequestVariant {
  SMS_SHORT
  SMS_STANDARD
  EMAIL
  FOLLOW_UP_SMS
  FOLLOW_UP_EMAIL
}

enum ReviewRequestStatus {
  PENDING
  SENT
  CLICKED
  REVIEWED
  OPTED_OUT
  SKIPPED
}

enum SocialPlatform {
  facebook
  instagram
  x
  googleBusiness
}

enum PostingMode {
  review
  auto
  campaign
}

enum QueueStatus {
  draft
  approved
  scheduled
  posted
  failed
}

enum ImagePlatform {
  instagram
  facebook
  x
  gbp
}

enum ImageCategory {
  educational
  promotion
  social_proof
  local_abstract
  evergreen
}

enum ImageStatus {
  queued
  generated
  fallback
  failed
  skipped
}

enum ImageProvider {
  nanoBananaFlash
  stub
}

enum ImageStorage {
  localDev
  vercelBlob
}

model ImageRequest {
  requestId         String       @id
  status            ImageStatus   @default(queued)

  platform          ImagePlatform
  category          ImageCategory
  aspect            String
  width             Int
  height            Int

  provider          ImageProvider?
  storage           ImageStorage?

  imageUrl          String?
  altText           String?

  errorCode         String?
  errorMessageSafe  String?
  fallbackReason    String?

  decisionJson      Json?
  promptHash        String?
  inputHash         String?

  // Optional retention
  expiresAt         DateTime?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  events            ImageEvent[]
  socialQueueItems  SocialQueueItem[]

  @@index([status])
  @@index([platform, category])
  @@index([createdAt])
}

model ImageEvent {
  id               String      @id @default(cuid())
  requestId         String
  type              String      // e.g. "provider_call", "storage_write", "fallback", "consumer_request"
  ok                Boolean     @default(true)
  messageSafe       String?
  data              Json?

  createdAt         DateTime    @default(now())

  request           ImageRequest @relation(fields: [requestId], references: [requestId], onDelete: Cascade)
  @@index([requestId])
  @@index([createdAt])
}

enum SocialConnectionPlatform {
  facebook
  instagram
  google_business
  x
}

model SocialAccountConnection {
  id                String                  @id @default(cuid())
  userId            String
  platform          SocialConnectionPlatform
  providerAccountId String                   // page id, ig business id, etc
  displayName       String
  accessToken       String                   // store securely; do NOT log; encrypt-at-rest if you have a helper
  tokenExpiresAt    DateTime?
  refreshToken      String?
  metaJson          Json?                   // safe metadata only
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, providerAccountId])
  @@index([userId])
  @@index([userId, platform])
}

model SocialPostingDestination {
  id                  String                  @id @default(cuid())
  userId              String
  platform            SocialConnectionPlatform
  selectedAccountId   String                   // selected page id or ig business id
  selectedDisplayName String
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@index([userId, platform])
}

model SocialPublishAttempt {
  id                String                  @id @default(cuid())
  userId            String
  platform          SocialConnectionPlatform
  kind              String                  @default("test") // "test" or future types
  status            String                  // "success" | "failed"
  providerPostId    String?
  providerPermalink String?
  errorMessage      String?                 // Safe, user-readable error
  createdAt         DateTime                @default(now())
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([platform])
}

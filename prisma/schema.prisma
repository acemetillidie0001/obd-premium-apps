generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String        @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  role          String        @default("user")
  isPremium     Boolean       @default(false)
  accounts      Account[]
  brandProfile  BrandProfile?
  sessions      Session[]
  businessMemberships BusinessUser[]

  @@index([email])
}

model Business {
  // IMPORTANT: This is the existing tenant key (V3 businessId == userId)
  id        String       @id
  name      String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  memberships BusinessUser[]
  invites     TeamInvite[]
}

model BusinessUser {
  id        String   @id @default(cuid())
  businessId String
  userId     String
  role      TeamRole @default(OWNER)
  status    String   @default("ACTIVE")
  lastActiveAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
}

model TeamInvite {
  id              String   @id @default(cuid())
  businessId       String
  email            String
  role             TeamRole @default(STAFF)
  tokenHash        String
  expiresAt        DateTime
  acceptedAt       DateTime?
  canceledAt       DateTime?
  createdByUserId  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([email])
  // NOTE: enforce one active invite per email per business in code (preferred)
  // @@unique([businessId, email])
}

model TeamAuditLog {
  id          String   @id @default(cuid())
  businessId  String
  actorUserId String
  action      String
  targetUserId String?
  targetEmail  String?
  metaJson    Json?
  createdAt   DateTime @default(now())

  @@index([businessId, createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProReport {
  id           String    @id @default(cuid())
  shareId      String    @unique
  html         String
  pdfBase64    String?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  businessName String
  city         String
  state        String
  score        Int
  accessToken  String?

  @@index([shareId])
  @@index([businessName, city, state])
  @@index([expiresAt])
}

model UsageCounter {
  id            String   @id @default(cuid())
  userId        String
  appId         String
  dayKey        String
  conceptsCount Int      @default(0)
  imagesCount   Int      @default(0)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  @@unique([userId, appId, dayKey])
  @@index([userId, appId, dayKey])
  @@index([dayKey])
}

model BrandProfile {
  id                         String   @id @default(cuid())
  userId                     String   @unique
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  businessName               String?
  businessType               String?
  city                       String?
  state                      String?
  brandPersonality           String?
  targetAudience             String?
  differentiators            String?
  inspirationBrands          String?
  avoidStyles                String?
  brandVoice                 String?
  toneNotes                  String?
  language                   String?
  industryKeywords           String?
  vibeKeywords               String?
  variationMode              String?
  includeHashtags            Boolean  @default(false)
  hashtagStyle               String?
  includeSocialPostTemplates Boolean  @default(false)
  includeFAQStarter          Boolean  @default(false)
  includeGBPDescription      Boolean  @default(false)
  includeMetaDescription     Boolean  @default(false)
  colorsJson                 Json?
  typographyJson             Json?
  messagingJson              Json?
  kitJson                    Json?
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ReviewRequestCampaign {
  id                String                   @id @default(cuid())
  userId            String
  businessName      String
  businessType      String?
  campaignName      String?
  platform          String
  reviewLinkUrl     String
  languageMode      String
  toneStyle         String
  brandVoice        String?
  channelMode       String
  triggerType       String
  sendDelayHours    Int                      @default(24)
  followUpEnabled   Boolean                  @default(false)
  followUpDelayDays Int?
  frequencyCapDays  Int                      @default(30)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  customers         ReviewRequestCustomer[]
  datasets          ReviewRequestDataset[]
  queueItems        ReviewRequestQueueItem[]

  @@index([userId])
  @@index([userId, createdAt])
}

model ReviewRequestCustomer {
  id            String                   @id @default(cuid())
  userId        String
  campaignId    String
  name          String
  email         String?
  phone         String?
  tags          String[]                 @default([])
  lastVisitDate DateTime?
  serviceType   String?
  jobId         String?
  optedOut      Boolean                  @default(false)
  createdAt     DateTime                 @default(now())
  campaign      ReviewRequestCampaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  queueItems    ReviewRequestQueueItem[]

  @@index([userId])
  @@index([campaignId])
  @@index([userId, createdAt])
}

model ReviewRequestQueueItem {
  id            String                @id @default(cuid())
  userId        String
  campaignId    String
  customerId    String
  scheduledAt   DateTime
  channel       ReviewRequestChannel
  variant       ReviewRequestVariant
  status        ReviewRequestStatus   @default(PENDING)
  skippedReason String?
  sentAt        DateTime?
  clickedAt     DateTime?
  reviewedAt    DateTime?
  optedOutAt    DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  campaign      ReviewRequestCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  customer      ReviewRequestCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([campaignId])
  @@index([customerId])
  @@index([userId, createdAt])
  @@index([status])
}

model ReviewRequestDataset {
  id           String                @id @default(cuid())
  userId       String
  campaignId   String
  snapshotId   String
  computedAt   DateTime              @default(now())
  totalsJson   Json
  warningsJson Json?
  createdAt    DateTime              @default(now())
  campaign     ReviewRequestCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([campaignId])
  @@index([userId, computedAt])
  @@index([snapshotId])
}

model SocialAutoposterSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  brandVoice            String?
  useBrandKit           Boolean? @default(true)
  postingMode           String   @default("review")
  frequency             String?
  allowedDays           String[] @default([])
  timeWindowStart       String?
  timeWindowEnd         String?
  timezone              String?  @default("America/New_York")
  enabledPlatforms      String[] @default([])
  platformsEnabled      Json?
  platformOverrides     Json?
  contentPillarSettings Json?
  hashtagBankSettings   Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  imageSettings         Json?

  @@index([userId])
}

model SocialQueueItem {
  id                  String                  @id @default(cuid())
  userId              String
  platform            SocialPlatform
  content             String
  status              QueueStatus             @default(draft)
  scheduledAt         DateTime?
  postedAt            DateTime?
  errorMessage        String?
  attemptCount        Int                     @default(0)
  metadata            Json?
  contentTheme        String?
  contentHash         String?
  contentFingerprint  String?
  reason              String?
  isSimilar           Boolean                 @default(false)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  imageStatus         String?
  imageUrl            String?
  imageAltText        String?
  imageProvider       String?
  imageAspect         String?
  imageCategory       String?
  imageErrorCode      String?
  imageFallbackReason String?
  imageRequestId      String?
  nextAttemptAt       DateTime?
  lastErrorCode       String?
  deliveryAttempts    SocialDeliveryAttempt[]

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([scheduledAt])
  @@index([userId, scheduledAt])
  @@index([nextAttemptAt])
  @@index([userId, nextAttemptAt])
  @@index([userId, platform, contentHash])
  @@index([contentHash])
}

model SocialDeliveryAttempt {
  id           String          @id @default(cuid())
  userId       String
  queueItemId  String
  platform     SocialPlatform
  success      Boolean
  errorMessage String?
  responseData Json?
  attemptedAt  DateTime        @default(now())
  queueItem    SocialQueueItem @relation(fields: [queueItemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([queueItemId])
  @@index([userId, attemptedAt])
  @@index([success])
}

model ImageRequest {
  requestId        String         @id
  status           ImageStatus    @default(queued)
  platform         ImagePlatform
  category         ImageCategory
  aspect           String
  width            Int
  height           Int
  provider         ImageProvider?
  storage          ImageStorage?
  imageUrl         String?
  altText          String?
  errorCode        String?
  errorMessageSafe String?
  fallbackReason   String?
  decisionJson     Json?
  promptHash       String?
  inputHash        String?
  expiresAt        DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  events           ImageEvent[]

  @@index([status])
  @@index([platform, category])
  @@index([createdAt])
}

model ImageEvent {
  id          String       @id @default(cuid())
  requestId   String
  type        String
  ok          Boolean      @default(true)
  messageSafe String?
  data        Json?
  createdAt   DateTime     @default(now())
  request     ImageRequest @relation(fields: [requestId], references: [requestId], onDelete: Cascade)

  @@index([requestId])
  @@index([createdAt])
}

model CrmContact {
  id               String               @id @default(cuid())
  businessId       String
  name             String
  email            String?
  phone            String?
  company          String?
  address          String?
  status           CrmContactStatus     @default(Lead)
  source           CrmContactSource     @default(manual)
  nextFollowUpAt   DateTime?
  nextFollowUpNote String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  activities       CrmContactActivity[]
  tags             CrmContactTag[]

  @@index([businessId])
  @@index([businessId, status])
  @@index([businessId, updatedAt])
  @@index([businessId, name])
  @@index([businessId, nextFollowUpAt])
}

model CrmTag {
  id         String          @id @default(cuid())
  businessId String
  name       String
  color      String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  contacts   CrmContactTag[]

  @@unique([businessId, name])
  @@index([businessId])
}

model CrmContactTag {
  id        String     @id @default(cuid())
  contactId String
  tagId     String
  createdAt DateTime   @default(now())
  contact   CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       CrmTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
}

model CrmContactActivity {
  id         String     @id @default(cuid())
  contactId  String
  businessId String
  type       String     @default("note")
  content    String?
  summary    String?
  occurredAt DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  contact    CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([businessId])
  @@index([businessId, createdAt])
  @@index([businessId, occurredAt])
}

model BookingService {
  id                 String           @id @default(cuid())
  businessId         String
  name               String
  durationMinutes    Int
  description        String?
  active             Boolean          @default(true)
  paymentRequired    PaymentRequired  @default(NONE)
  depositAmountCents Int?
  currency           String?          @default("USD")
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  requests           BookingRequest[]

  @@index([businessId])
  @@index([businessId, active])
}

model BookingSettings {
  id                 String      @id @default(cuid())
  businessId         String      @unique
  bookingModeDefault BookingMode @default(REQUEST_ONLY)
  timezone           String      @default("America/New_York")
  bufferMinutes      Int         @default(15)
  minNoticeHours     Int         @default(24)
  maxDaysOut         Int         @default(90)
  policyText         String?
  bookingKey         String      @unique
  notificationEmail  String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([businessId])
  @@index([bookingKey])
}

model BookingPublicLink {
  id         String   @id @default(cuid())
  businessId String   @unique
  code       String   @unique
  slug       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([businessId])
  @@index([code])
  @@index([slug])
}

model BookingRequest {
  id             String                   @id @default(cuid())
  businessId     String
  serviceId      String?
  customerName   String
  customerEmail  String
  customerPhone  String?
  preferredStart DateTime?
  preferredEnd   DateTime?
  message        String?
  status         BookingStatus            @default(REQUESTED)
  proposedStart  DateTime?
  proposedEnd    DateTime?
  internalNotes  String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  service        BookingService?          @relation(fields: [serviceId], references: [id], onUpdate: NoAction)
  auditLogs      BookingRequestAuditLog[]

  @@index([businessId])
  @@index([businessId, status])
  @@index([businessId, createdAt])
  @@index([status])
}

model BookingRequestAuditLog {
  id          String         @id @default(cuid())
  businessId  String
  requestId   String
  actorUserId String?
  action      String
  fromStatus  BookingStatus
  toStatus    BookingStatus
  metadata    Json?
  createdAt   DateTime       @default(now())
  request     BookingRequest @relation(fields: [requestId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([businessId])
  @@index([requestId])
  @@index([requestId, createdAt])
  @@index([businessId, createdAt])
}

model RateLimitEvent {
  id             String   @id @default(cuid())
  businessId     String
  routeKey       String
  day            DateTime @db.Date
  violationCount Int      @default(0)
  successCount   Int      @default(0)
  hashedKey      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([businessId, routeKey, day])
  @@index([businessId])
  @@index([businessId, day])
  @@index([routeKey, day])
}

model AvailabilityWindow {
  id         String   @id @default(cuid())
  businessId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  isEnabled  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, dayOfWeek])
  @@index([businessId])
  @@index([businessId, dayOfWeek])
}

model AvailabilityException {
  id         String                    @id @default(cuid())
  businessId String
  date       DateTime                  @db.Date
  startTime  String?
  endTime    String?
  type       AvailabilityExceptionType
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt

  @@unique([businessId, date])
  @@index([businessId])
  @@index([businessId, date])
}

model BookingTheme {
  id           String   @id @default(cuid())
  businessId   String   @unique
  logoUrl      String?
  primaryColor String?  @default("#29c4a9")
  accentColor  String?
  headlineText String?
  introText    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([businessId])
}

model SchedulerCalendarConnection {
  id              String   @id @default(cuid())
  businessId      String
  provider        String
  accountEmail    String?
  accessTokenEnc  String
  refreshTokenEnc String?
  expiresAt       DateTime
  enabled         Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([businessId, provider])
  @@index([businessId])
  @@index([businessId, provider])
}

enum ReviewRequestChannel {
  EMAIL
  SMS
}

enum TeamRole {
  OWNER
  ADMIN
  STAFF
}

enum ReviewRequestVariant {
  SMS_SHORT
  SMS_STANDARD
  EMAIL
  FOLLOW_UP_SMS
  FOLLOW_UP_EMAIL
}

enum ReviewRequestStatus {
  PENDING
  SENT
  CLICKED
  REVIEWED
  OPTED_OUT
  SKIPPED
}

enum SocialPlatform {
  facebook
  instagram
  x
  googleBusiness
}

enum PostingMode {
  review
  auto
  campaign
}

enum QueueStatus {
  draft
  approved
  scheduled
  posted
  failed
}

enum ImagePlatform {
  instagram
  facebook
  x
  gbp
}

enum ImageCategory {
  educational
  promotion
  social_proof
  local_abstract
  evergreen
}

enum ImageStatus {
  queued
  generated
  fallback
  failed
  skipped
}

enum ImageProvider {
  nanoBananaFlash
  stub
}

enum ImageStorage {
  localDev
  vercelBlob
}

enum CrmContactStatus {
  Lead
  Active
  Past
  DoNotContact
}

enum CrmContactSource {
  manual
  scheduler
  reviews
  helpdesk
  import
}

enum BookingStatus {
  REQUESTED
  APPROVED
  DECLINED
  PROPOSED_TIME
  COMPLETED
  CANCELED
}

enum BookingMode {
  REQUEST_ONLY
  INSTANT_ALLOWED
}

enum PaymentRequired {
  NONE
  DEPOSIT
  FULL
}

enum AvailabilityExceptionType {
  CLOSED_ALL_DAY
  CUSTOM_HOURS
}

model AiHelpDeskEntry {
  id        String                @id @default(cuid())
  businessId String
  type      AiHelpDeskEntryType
  title     String
  content   String                @db.Text
  tags      String[]              @default([])
  isActive  Boolean               @default(true)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([businessId])
  @@index([businessId, type])
  @@index([businessId, isActive])
}

model AiHelpDeskQuestionLog {
  id              String                      @id @default(cuid())
  businessId      String
  question        String                      @db.Text
  hasSources      Boolean                     @default(false)
  sourcesCount    Int                         @default(0)
  responseQuality AiHelpDeskResponseQuality?
  matchedEntryIds String[]                    @default([])
  createdAt       DateTime                    @default(now())

  @@index([businessId])
  @@index([businessId, createdAt])
}

model AiHelpDeskWidgetKey {
  id        String   @id @default(cuid())
  businessId String  @unique
  publicKey String
  createdAt DateTime @default(now())
  rotatedAt DateTime?

  @@index([businessId])
}

model AiHelpDeskWidgetSettings {
  id                String   @id @default(cuid())
  businessId        String   @unique
  enabled            Boolean  @default(false)
  brandColor         String?  @default("#29c4a9")
  greeting           String?  @default("Hi! How can I help you today?")
  position           String?  @default("bottom-right")
  assistantAvatarUrl String?
  allowedDomains     String[] @default([])
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([businessId])
}

model AiHelpDeskSyncState {
  id              String   @id @default(cuid())
  businessId      String   @unique
  lastSyncedAt    DateTime?
  lastSyncStatus  String?
  lastSyncError   String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([businessId])
}

model AiWorkspaceMap {
  id            String   @id @default(cuid())
  businessId    String   @unique
  workspaceSlug String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([businessId])
  @@index([workspaceSlug])
}

enum AiHelpDeskEntryType {
  FAQ
  SERVICE
  POLICY
  NOTE
}

enum AiHelpDeskResponseQuality {
  GOOD
  WEAK
  NONE
}

model BusinessDescriptionSavedVersion {
  id        String   @id @default(cuid())
  businessId String
  title     String
  businessName String
  city      String?
  state     String?
  versionName String?
  inputs    Json
  outputs   Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, isActive])
}

// Tier 6-1: AI Review Responder - immutable response history snapshots (tenant-scoped)
model ReviewResponseSnapshot {
  id          String   @id @default(uuid())
  businessId  String
  createdAt   DateTime @default(now())
  inputSummary Json
  responses    Json

  @@index([businessId])
  @@index([businessId, createdAt])
}

model SchedulerBusyBlock {
  id         String   @id @default(cuid())
  businessId String
  start      DateTime
  end        DateTime
  reason     String?
  source     String   @default("manual")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, start])
  @@index([businessId, end])
}

model SocialAccountConnection {
  id                String   @id @default(cuid())
  userId            String
  platform          String
  providerAccountId String
  displayName       String?
  accessToken       String
  refreshToken      String?
  tokenExpiresAt    DateTime?
  metaJson          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, platform, providerAccountId], name: "userId_platform_providerAccountId")
  @@index([userId])
  @@index([userId, platform])
}

model SocialPostingDestination {
  id                  String   @id @default(cuid())
  userId              String
  platform            String
  selectedAccountId   String?
  selectedDisplayName String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, platform], name: "userId_platform")
  @@index([userId])
  @@index([userId, platform])
}

model SocialPublishAttempt {
  id                String   @id @default(cuid())
  userId            String
  platform          String
  kind              String   @default("test") // "test" | "scheduled" | "manual"
  status            String   @default("pending") // "pending" | "success" | "failed"
  providerPostId    String?
  providerPermalink String?
  errorMessage      String?  @db.Text
  responseData      Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([userId, platform])
  @@index([userId, createdAt])
  @@index([status])
}

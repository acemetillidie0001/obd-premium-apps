# Review Request Automation Migration Safety Audit

## Migration Name
`obd_review_requests_shared_dataset_20251224`

## Purpose
This migration adds Review Request Automation tables with:
- Enum types for type safety (channel, variant, status)
- Dataset tables with `totalsJson` and `warningsJson`
- Proper indexes for performance

## Pre-Migration Assessment

### Current Database State
✅ **No existing tables detected** - The Review Request Automation tables (`ReviewRequestCampaign`, `ReviewRequestCustomer`, `ReviewRequestQueueItem`, `ReviewRequestDataset`) do not exist in any previous migrations.

**Conclusion:** This is a **CREATE-only migration** with **zero data loss risk** since no existing tables or data will be modified.

## Migration Safety Checklist

After running `npx prisma migrate dev --name obd_review_requests_shared_dataset_20251224`, verify the generated SQL:

### ✅ Expected Safe Operations

1. **Enum Creation:**
   ```sql
   CREATE TYPE "ReviewRequestChannel" AS ENUM ('EMAIL', 'SMS');
   CREATE TYPE "ReviewRequestVariant" AS ENUM ('SMS_SHORT', 'SMS_STANDARD', 'EMAIL', 'FOLLOW_UP_SMS', 'FOLLOW_UP_EMAIL');
   CREATE TYPE "ReviewRequestStatus" AS ENUM ('PENDING', 'SENT', 'CLICKED', 'REVIEWED', 'OPTED_OUT', 'SKIPPED');
   ```
   **Status:** ✅ Safe - Creating new types, no data affected

2. **Table Creation:**
   - `ReviewRequestCampaign` - new table
   - `ReviewRequestCustomer` - new table
   - `ReviewRequestQueueItem` - new table with enum columns
   - `ReviewRequestDataset` - new table with `totalsJson` and `warningsJson`
   **Status:** ✅ Safe - Creating new tables, no existing data

3. **Index Creation:**
   All indexes are created on new tables.
   **Status:** ✅ Safe - No existing data to reorganize

### ⚠️ Potential Issues to Watch For

**None expected** - Since tables don't exist, there's no:
- Column renames (no `totals` → `totalsJson` rename needed)
- Data type conversions (no string → enum conversions needed)
- Data migration steps required

## Post-Migration Verification

After migration completes:

```sql
-- Verify enum types exist
SELECT typname FROM pg_type WHERE typname IN (
  'ReviewRequestChannel',
  'ReviewRequestVariant', 
  'ReviewRequestStatus'
);

-- Verify tables exist
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename LIKE 'ReviewRequest%';

-- Verify columns
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'ReviewRequestDataset'
ORDER BY ordinal_position;

-- Verify indexes
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename LIKE 'ReviewRequest%';
```

Expected results:
- 3 enum types created
- 4 tables created
- `ReviewRequestDataset.totalsJson` exists (JSONB, NOT NULL)
- `ReviewRequestDataset.warningsJson` exists (JSONB, NULLABLE)
- All indexes created successfully

## Migration Command Sequence

```bash
# 1. Generate migration
npx prisma migrate dev --name obd_review_requests_shared_dataset_20251224

# 2. Review generated SQL (REQUIRED)
# File: prisma/migrations/*_obd_review_requests_shared_dataset_20251224/migration.sql
# Verify: Only CREATE operations, no ALTER or DROP

# 3. Generate Prisma Client
npx prisma generate

# 4. Deploy to production
npx prisma migrate deploy
```

## Rollback Plan

If migration needs to be rolled back:

```sql
-- Drop tables (cascades to indexes)
DROP TABLE IF EXISTS "ReviewRequestDataset" CASCADE;
DROP TABLE IF EXISTS "ReviewRequestQueueItem" CASCADE;
DROP TABLE IF EXISTS "ReviewRequestCustomer" CASCADE;
DROP TABLE IF EXISTS "ReviewRequestCampaign" CASCADE;

-- Drop enum types
DROP TYPE IF EXISTS "ReviewRequestStatus";
DROP TYPE IF EXISTS "ReviewRequestVariant";
DROP TYPE IF EXISTS "ReviewRequestChannel";
```

⚠️ **Warning:** Rollback will delete all Review Request Automation data. Only use if migration failed and tables are in invalid state.

## Safety Conclusion

**OPTION A — Migration is safe as generated**

✅ **Confirmed:** This is a CREATE-only migration with zero risk of data loss because:
- No existing tables exist to modify
- No existing data to migrate
- No column renames required
- No enum conversions required
- All new columns are either required with defaults or nullable

**No safety adjustments required.** The migration can be deployed as generated by Prisma.

## Future Migration Considerations

If you need to modify these tables in the future:

1. **Column Renames:** Always verify Prisma uses `ALTER TABLE ... RENAME COLUMN` (preserves data)
2. **Enum Additions:** Adding enum values is safe: `ALTER TYPE enum_name ADD VALUE 'NEW_VALUE'`
3. **Enum Removals:** Removing enum values requires data migration first (set affected rows to a remaining value)
4. **Type Changes:** Converting between types requires explicit data conversion logic

## V3.5 Enhancements

The migration supports V3.5 features including:
- Insights generation using `warningsJson` and `totalsJson`
- Two-way awareness features using `computedAt` for latest dataset detection
- No schema changes required for V3.5 features (uses existing columns)


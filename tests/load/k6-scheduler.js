/**
 * k6 Load Test for OBD Scheduler
 * P1-27: Load Testing Script
 * 
 * Tests:
 * 1) GET /api/obd-scheduler/public/context?bookingKey=...
 * 2) POST /api/obd-scheduler/requests with a valid payload
 * 
 * Run with: k6 run tests/load/k6-scheduler.js
 * Or via package.json: pnpm test:load
 * 
 * Environment variables:
 * - BASE_URL: Base URL (default: http://localhost:3000)
 * - BOOKING_KEY: Valid booking key for testing (required)
 * 
 * Safe defaults: 5 VUs, 30s duration
 */

import http from "k6/http";
import { check, sleep } from "k6";
import { Rate } from "k6/metrics";

// Custom metrics
const errorRate = new Rate("errors");

// Configuration from environment variables
const baseURL = __ENV.BASE_URL || "http://localhost:3000";
const bookingKey = __ENV.BOOKING_KEY || "";

// Safe defaults: 5 VUs, 30s duration
export const options = {
  vus: 5,
  duration: "30s",
  thresholds: {
    http_req_duration: ["p(95)<2000"], // 95% of requests should be below 2s
    http_req_failed: ["rate<0.1"], // Error rate should be less than 10%
    errors: ["rate<0.1"],
  },
};

export default function () {
  // Validate booking key
  if (!bookingKey) {
    console.error("BOOKING_KEY environment variable is required");
    return;
  }

  // Test 1: GET /api/obd-scheduler/public/context?bookingKey=...
  const contextUrl = `${baseURL}/api/obd-scheduler/public/context?bookingKey=${encodeURIComponent(bookingKey)}`;
  const contextRes = http.get(contextUrl);
  
  const contextCheck = check(contextRes, {
    "context status is 200": (r) => r.status === 200,
    "context response has valid structure": (r) => {
      try {
        const body = JSON.parse(r.body);
        return body.ok === true && body.data !== undefined;
      } catch {
        return false;
      }
    },
  });
  errorRate.add(!contextCheck);
  
  sleep(1);

  // Test 2: POST /api/obd-scheduler/requests with a valid payload
  const requestPayload = JSON.stringify({
    bookingKey: bookingKey,
    customerName: `Load Test User ${__VU}-${__ITER}`,
    customerEmail: `loadtest-${__VU}-${__ITER}@example.com`,
    customerPhone: "555-0000",
    message: "Load test request generated by k6",
  });

  const createRes = http.post(
    `${baseURL}/api/obd-scheduler/requests`,
    requestPayload,
    {
      headers: { "Content-Type": "application/json" },
    }
  );

  const createCheck = check(createRes, {
    "create request status is 200 or 201": (r) => r.status === 200 || r.status === 201 || r.status === 429,
    "create request has valid response": (r) => {
      try {
        const body = JSON.parse(r.body);
        return body.ok !== undefined;
      } catch {
        return false;
      }
    },
  });
  errorRate.add(!createCheck);
  
  sleep(1);
}

export function handleSummary(data) {
  return {
    stdout: JSON.stringify(data, null, 2),
  };
}

